name: Code Quality

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]
  schedule:
    # Run every Sunday at 3:00 AM UTC
    - cron: '0 3 * * 0'

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript compiler check
        run: npx tsc --noEmit

      - name: Check code complexity
        run: |
          echo "ğŸ“Š Code Complexity Analysis"
          # Install complexity checker
          npx complexity-report src/ --format json > complexity.json || true
          
          if [ -f complexity.json ]; then
            echo "âœ… Complexity report generated"
            cat complexity.json
          fi

      - name: Check for TODO/FIXME comments
        run: |
          echo "ğŸ“ Scanning for TODO/FIXME comments..."
          grep -rn "TODO\|FIXME" src/ || echo "âœ… No TODO/FIXME found"

      - name: Check file sizes
        run: |
          echo "ğŸ“¦ Large Files Report"
          find src/ -type f -size +100k -exec ls -lh {} \; | awk '{print $9, $5}' || echo "âœ… No large files found"

      - name: Duplicate code detection
        run: |
          echo "ğŸ” Checking for duplicate code..."
          npx jscpd src/ --min-lines 10 --min-tokens 50 --format "markdown" || echo "âœ… No significant duplicates found"

      - name: Security linting
        run: |
          echo "ğŸ”’ Security Linting"
          npm audit --audit-level=high || echo "âš ï¸ Security issues found"

  test-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Check test coverage thresholds
        run: |
          echo "ğŸ“ˆ Coverage Thresholds Check"
          # Parse coverage summary
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Current coverage: $COVERAGE%"
          
          THRESHOLD=70
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "âŒ Coverage $COVERAGE% is below threshold $THRESHOLD%"
            exit 1
          else
            echo "âœ… Coverage meets threshold"
          fi

      - name: Upload coverage to artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  documentation-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check README
        run: |
          echo "ğŸ“š Documentation Check"
          
          # Check if README exists and has content
          if [ -f README.md ] && [ $(wc -l < README.md) -gt 10 ]; then
            echo "âœ… README.md exists and has content"
          else
            echo "âŒ README.md is missing or empty"
            exit 1
          fi

      - name: Check for API documentation
        run: |
          # Check for common documentation patterns
          for file in src/**/*.ts; do
            if grep -q "export.*function\|export.*class" "$file"; then
              if ! grep -q "\/\*\*" "$file"; then
                echo "âš ï¸ $file may need JSDoc comments"
              fi
            fi
          done

      - name: Check CHANGELOG
        run: |
          if [ -f CHANGELOG.md ]; then
            echo "âœ… CHANGELOG.md exists"
          else
            echo "âš ï¸ Consider adding a CHANGELOG.md"
          fi

  dependency-health:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Check for unused dependencies
        run: |
          echo "ğŸ“¦ Checking for unused dependencies..."
          npx depcheck || echo "âš ï¸ Check dependencies manually"

      - name: Check package.json validity
        run: |
          echo "ğŸ“ Validating package.json..."
          node -e "JSON.parse(require('fs').readFileSync('package.json'))" && echo "âœ… Valid JSON"

      - name: License compliance check
        run: |
          echo "âš–ï¸ License Compliance"
          npx license-checker --summary || echo "âš ï¸ Manual license review needed"

  report:
    runs-on: ubuntu-latest
    needs: [code-quality, test-quality, documentation-check, dependency-health]
    if: always()
    steps:
      - name: Generate quality report
        run: |
          echo "## ğŸ“Š Code Quality Report" > report.md
          echo "" >> report.md
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> report.md
          echo "- Test Quality: ${{ needs.test-quality.result }}" >> report.md
          echo "- Documentation: ${{ needs.documentation-check.result }}" >> report.md
          echo "- Dependencies: ${{ needs.dependency-health.result }}" >> report.md
          
          cat report.md

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: report.md
